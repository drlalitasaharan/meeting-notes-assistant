name: CI
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build images
        run: docker compose build
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: docker compose up -d
      - name: Wait for API
        run: |
          for i in {1..60}; do
            curl -fsS http://localhost:8000/metrics && break
            sleep 2
          done
      - name: Smoke â€“ process meeting 1
        run: |
          set -e
          mkdir -p storage/1
          echo "Test OCR slide" > storage/1/slide.txt
          convert -size 600x200 xc:white -pointsize 32 -gravity center -annotate 0 "Hello OCR" storage/1/slide.png || true
          JOB=$(curl -fsS -XPOST http://localhost:8000/v1/meetings/1/process | jq -r .job_id)
          echo "JOB=$JOB"
          for i in {1..60}; do
            S=$(curl -fsS http://localhost:8000/v1/jobs/$JOB | jq -r .status)
            echo "status=$S"
            [ "$S" = "finished" ] && break
            sleep 2
          done
          curl -fsS http://localhost:8000/v1/meetings/1/notes
