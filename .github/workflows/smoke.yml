name: Smoke
on:
  pull_request: { branches: [ main ] }
  workflow_dispatch:
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq httpie
      - name: Docker Build
        run: docker compose build
      - name: Up stack
        run: docker compose -f docker-compose.yml -f docker-compose.prodready.yml up -d redis minio api worker
      - name: Wait for API
        run: |
          for i in {1..60}; do curl -fsS http://localhost:8000/healthz && break || sleep 5; done
      - name: Enqueue demo job
        id: enqueue
        run: |
          JOB_ID=$(curl -fsS -H 'Content-Type: application/json' -d '{"type":"demo"}' http://localhost:8000/v1/jobs | jq -r .id)
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
      - name: Poll job
        run: |
          for i in {1..60}; do
            ST=$(curl -fsS http://localhost:8000/v1/jobs/${{ steps.enqueue.outputs.job_id }} | jq -r .status)
            echo "$i: $ST"
            test "$ST" = "succeeded" && exit 0
            sleep 2
          done
          echo "Job did not succeed in time" >&2
          exit 1
      - name: Validate artifact
        run: |
          ART=$(curl -fsS http://localhost:8000/v1/jobs/${{ steps.enqueue.outputs.job_id }} | jq -r .artifact_url)
          curl -fsS "$ART" -o /tmp/out && test -s /tmp/out
