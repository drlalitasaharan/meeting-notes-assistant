name: Smoke

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      # SQLite is fine for smoke; Postgres is handled elsewhere.
      DATABASE_URL: sqlite:////app/backend/dev.db

      # Redis / RQ config for backend + worker stack
      REDIS_URL: redis://redis:6379/0
      RQ_QUEUE_NAME: default
      RQ_SMOKE_TIMEOUT: "20.0"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin

      - name: Build and start prodready stack (backend + worker + redis)
        run: |
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.prodready.yml \
            -f docker-compose.uvicorn.yml \
            up -d --build backend worker redis

      - name: Wait for API (/healthz)
        run: |
          set -e
          echo "Waiting for /healthz to respond with 200..."
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8000/healthz; then
              echo "API is healthy"
              exit 0
            fi
            echo "Healthz not ready yet ($i/30)..."
            sleep 2
          done

          echo "API never became healthy" >&2
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.prodready.yml \
            -f docker-compose.uvicorn.yml \
            logs backend worker redis || true
          exit 1

      - name: RQ smoke job (enqueue + wait)
        run: |
          set -e
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.prodready.yml \
            -f docker-compose.uvicorn.yml \
            exec -T backend \
            env REDIS_URL="$REDIS_URL" RQ_QUEUE_NAME="$RQ_QUEUE_NAME" RQ_SMOKE_TIMEOUT="$RQ_SMOKE_TIMEOUT" \
            python -m app.jobs.smoke

      - name: Tear down stack
        if: always()
        run: |
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.prodready.yml \
            -f docker-compose.uvicorn.yml \
            down -v
